# Руководство по устранению неполадок NM Script

Решения для распространённых проблем и ошибок при работе с NM Script.

## Содержание

- [Ошибки компиляции](#ошибки-компиляции)
- [Проблемы с персонажами](#проблемы-с-персонажами)
- [Проблемы со сценами](#проблемы-со-сценами)
- [Проблемы с переменными](#проблемы-с-переменными)
- [Проблемы с ресурсами](#проблемы-с-ресурсами)
- [Проблемы с локализацией](#проблемы-с-локализацией)
- [Общие проблемы](#общие-проблемы)

---

## Ошибки компиляции

### Ошибка: "Expected ';'"

**Проблема**: Пропущена точка с запятой после оператора.

**Причины**:
- Не закрыта строка кавычкой `"`
- Не закрыт блок фигурной скобкой `}`
- Опечатка в ключевом слове

**Решение**:

❌ **Неправильно**:
```nms
say Hero "Привет  // Нет закрывающей кавычки
```

✅ **Правильно**:
```nms
say Hero "Привет"
```

### Ошибка: "Unexpected token"

**Проблема**: Компилятор встретил неожиданный символ.

**Причины**:
- Опечатка в ключевом слове
- Использование зарезервированного слова как идентификатора
- Неправильный синтаксис

**Решение**:

❌ **Неправильно**:
```nms
scène intro {  // Неправильное ключевое слово
    ...
}
```

✅ **Правильно**:
```nms
scene intro {
    ...
}
```

### Ошибка: "Invalid identifier"

**Проблема**: Идентификатор не соответствует правилам именования.

**Причины**:
- Идентификатор начинается с цифры
- Содержит недопустимые символы (дефис, пробел)

**Решение**:

❌ **Неправильно**:
```nms
scene 1st-scene {  // Начинается с цифры, содержит дефис
    ...
}
```

✅ **Правильно**:
```nms
scene first_scene {
    ...
}
```

### Ошибка: "Unclosed string literal"

**Проблема**: Строка не закрыта кавычкой.

**Решение**:

❌ **Неправильно**:
```nms
say Hero "Это текст
say Hero "А это другой текст"
```

✅ **Правильно**:
```nms
say Hero "Это текст"
say Hero "А это другой текст"
```

---

## Проблемы с персонажами

### Ошибка: "Undefined character 'Hero'"

**Проблема**: Вы используете персонажа, не объявив его.

**Решение**: Добавьте объявление персонажа в начало файла.

❌ **Неправильно**:
```nms
scene intro {
    say Hero "Привет!"  // Hero не объявлен
}
```

✅ **Правильно**:
```nms
character Hero(name="Герой")

scene intro {
    say Hero "Привет!"
}
```

### Проблема: Персонаж не отображается

**Причины**:
- Персонаж не показан командой `show`
- Фон не установлен (персонаж может быть скрыт)
- Неправильный Z-order (порядок слоёв)

**Решение**:

**Чек-лист**:
- [ ] Персонаж объявлен?
- [ ] Использована команда `show Character`?
- [ ] Фон показан перед персонажем?
- [ ] Проверьте Scene Preview на Z-order

✅ **Правильный порядок**:
```nms
scene intro {
    show background "bg_room"  // Сначала фон
    show Hero at center        // Потом персонаж
    say Hero "Теперь меня видно!"
}
```

### Проблема: Цвет имени персонажа не применяется

**Причина**: Неправильный формат цвета.

**Решение**: Используйте шестнадцатеричный формат `#RRGGBB`.

❌ **Неправильно**:
```nms
character Hero(name="Герой", color="blue")  // Неверный формат
```

✅ **Правильно**:
```nms
character Hero(name="Герой", color="#4A90D9")
```

**Полезные цвета**:
- Красный: `#D94A4A`
- Синий: `#4A90D9`
- Зелёный: `#4AD94A`
- Жёлтый: `#D9D94A`
- Фиолетовый: `#D94AD9`
- Белый: `#FFFFFF`
- Серый: `#808080`

### Проблема: Персонаж появляется не на той позиции

**Причина**: Неправильное имя позиции.

**Решение**: Используйте стандартные позиции: `left`, `center`, `right`.

❌ **Неправильно**:
```nms
show Hero at middle  // Неверная позиция
```

✅ **Правильно**:
```nms
show Hero at center
```

---

## Проблемы со сценами

### Ошибка: "Scene 'intro' not found"

**Проблема**: Попытка перейти к несуществующей сцене.

**Причины**:
- Опечатка в имени сцены
- Сцена не объявлена
- Сцена в другом файле (не импортирована)

**Решение**:

❌ **Неправильно**:
```nms
scene start {
    goto intto  // Опечатка
}

scene intro {
    ...
}
```

✅ **Правильно**:
```nms
scene start {
    goto intro
}

scene intro {
    ...
}
```

### Проблема: Скрипт не запускается

**Причины**:
- Файл не сохранён с расширением `.nms`
- Файл не в папке `scripts/`
- Первая сцена не определена
- Есть синтаксические ошибки

**Чек-лист**:
- [ ] Файл сохранён с расширением `.nms`?
- [ ] Файл в папке `scripts/`?
- [ ] Есть хотя бы одна сцена?
- [ ] Нет ошибок в панели Issues?

### Проблема: Бесконечный цикл

**Причина**: Сцены переходят друг в друга циклично без условия выхода.

**Решение**: Добавьте условие или выбор для выхода из цикла.

❌ **Неправильно**:
```nms
scene a {
    goto b
}

scene b {
    goto a  // Бесконечный цикл
}
```

✅ **Правильно**:
```nms
var count = 0

scene a {
    set count = count + 1

    if count >= 5 {
        goto end
    } else {
        goto b
    }
}

scene b {
    goto a
}

scene end {
    say "Цикл завершён!"
}
```

### Проблема: "Мёртвый конец" сцены

**Проблема**: Сцена завершается без перехода к другой сцене или окончания.

**Решение**: Добавьте `goto` или явное завершение.

❌ **Неправильно**:
```nms
scene dead_end {
    say Hero "Что теперь?"
    // Сцена просто заканчивается
}
```

✅ **Правильно**:
```nms
scene not_dead_end {
    say Hero "Что теперь?"
    goto next_scene
}

scene next_scene {
    say Hero "Продолжаем!"
}
```

---

## Проблемы с переменными

### Ошибка: "Undefined variable 'score'"

**Проблема**: Переменная используется, но не объявлена.

**Решение**: Объявите переменную с помощью `var`.

❌ **Неправильно**:
```nms
scene test {
    set score = 100  // score не объявлен
}
```

✅ **Правильно**:
```nms
var score = 0

scene test {
    set score = 100
}
```

### Проблема: Переменная не изменяется

**Причина**: Использование `var` вместо `set` для изменения.

**Решение**: Используйте `var` только для объявления, `set` для изменения.

❌ **Неправильно**:
```nms
var score = 0

scene test {
    var score = 100  // Создаёт новую локальную переменную!
}
```

✅ **Правильно**:
```nms
var score = 0

scene test {
    set score = 100  // Изменяет существующую переменную
}
```

### Проблема: Условие не работает

**Причины**:
- Неправильный оператор сравнения
- Неверный тип данных
- Опечатка в имени переменной

**Решение**:

❌ **Неправильно**:
```nms
if score = 100 {  // Используется = вместо ==
    ...
}
```

✅ **Правильно**:
```nms
if score == 100 {
    ...
}
```

**Операторы сравнения**:
- `==` - равно
- `!=` - не равно
- `>` - больше
- `<` - меньше
- `>=` - больше или равно
- `<=` - меньше или равно

### Проблема: Переменная в тексте не заменяется

**Причина**: Не используются фигурные скобки `{}`.

**Решение**:

❌ **Неправильно**:
```nms
var name = "Алекс"

scene test {
    say Hero "Меня зовут name"  // Выведет: "Меня зовут name"
}
```

✅ **Правильно**:
```nms
var name = "Алекс"

scene test {
    say Hero "Меня зовут {name}"  // Выведет: "Меня зовут Алекс"
}
```

---

## Проблемы с ресурсами

### Ошибка: "Asset not found: 'bg_room.png'"

**Проблема**: Файл ресурса не найден.

**Причины**:
- Неправильный путь к файлу
- Файл не импортирован в Assets
- Опечатка в имени файла
- Неправильное расширение файла

**Решение**:

**Чек-лист**:
- [ ] Файл существует в папке `assets/images/`?
- [ ] Путь указан правильно?
- [ ] Расширение файла правильное (.png, .jpg)?
- [ ] Имя файла без пробелов и спецсимволов?

✅ **Правильно**:
```nms
// Относительный путь от корня проекта
show background "assets/images/bg_room.png"

// Или краткий путь, если настроен
show background "bg_room"
```

### Проблема: Изображение не загружается

**Причины**:
- Неподдерживаемый формат (используйте PNG или JPG)
- Файл повреждён
- Файл слишком большой

**Решение**:
- Используйте PNG или JPG
- Проверьте файл в редакторе изображений
- Оптимизируйте размер файла (рекомендуется до 2 МБ)

### Проблема: Звук не воспроизводится

**Причины**:
- Неподдерживаемый формат (используйте WAV или OGG)
- Неправильный путь к файлу
- Громкость установлена на 0

**Решение**:

✅ **Правильно**:
```nms
// Правильный путь
play music "assets/audio/music/theme.wav" loop=true

// Проверьте формат файла
// Поддерживаются: .wav, .ogg, .mp3
```

### Проблема: Музыка не зацикливается

**Причина**: Не указан параметр `loop=true`.

**Решение**:

❌ **Неправильно**:
```nms
play music "theme.wav"  // Воспроизведётся один раз
```

✅ **Правильно**:
```nms
play music "theme.wav" loop=true  // Зациклится
```

---

## Проблемы с локализацией

### Ошибка: "Localization key not found: 'dialog.hero.greeting'"

**Проблема**: Ключ локализации не найден в файле локализации.

**Решение**:

1. Проверьте, что ключ существует в файле локализации
2. Убедитесь, что путь правильный
3. Проверьте JSON-файл на ошибки синтаксиса

**Файл** `localization/ru.json`:
```json
{
  "dialog.hero.greeting": "Привет, мир!"
}
```

**Скрипт**:
```nms
say Hero loc("dialog.hero.greeting")
```

### Проблема: Локализация не применяется

**Причины**:
- Неправильный путь к файлу локализации
- JSON-файл содержит ошибки
- Неправильный синтаксис `loc()`

**Решение**:

1. Проверьте JSON на валидность (используйте онлайн-валидатор)
2. Убедитесь, что файл в папке `localization/`
3. Проверьте имя файла: `en.json`, `ru.json`

### Проблема: Текст на неправильном языке

**Причина**: Неправильно установлена локаль в настройках.

**Решение**:
- Проверьте настройки языка в редакторе
- Убедитесь, что файл локализации для выбранного языка существует

---

## Общие проблемы

### Проблема: Изменения не применяются

**Причины**:
- Файл не сохранён (`Ctrl+S`)
- Нужно перезапустить сцену
- Кэш не очищен

**Решение**:
1. Сохраните файл (`Ctrl+S`)
2. Остановите и перезапустите сцену (Stop → Play)
3. При необходимости: File → Clear Cache

### Проблема: Медленная работа

**Причины**:
- Слишком большие файлы изображений
- Слишком много ресурсов в одной сцене
- Бесконечный цикл обновления

**Решение**:
- Оптимизируйте изображения (используйте разумное разрешение)
- Выгружайте неиспользуемые ресурсы
- Проверьте логику на циклы

### Проблема: Консоль показывает ошибки, но скрипт работает

**Причина**: Ошибки могут быть предупреждениями (warnings), а не критическими.

**Решение**:
- Прочитайте сообщение ошибки полностью
- Обратите внимание на уровень: ERROR (критично), WARNING (предупреждение), INFO (информация)
- Исправьте ошибки уровня ERROR в первую очередь

### Проблема: "Cannot read property of undefined"

**Причина**: Обращение к несуществующему объекту или переменной.

**Решение**:
1. Проверьте, что все переменные объявлены
2. Убедитесь, что персонажи и сцены существуют
3. Проверьте порядок объявлений

---

## Отладка

### Как найти ошибку

1. **Читайте сообщения об ошибках** - они обычно указывают файл и строку
2. **Проверяйте консоль** - панель Console показывает все ошибки
3. **Используйте комментарии** - закомментируйте код, чтобы изолировать проблему
4. **Тестируйте поэтапно** - проверяйте каждую сцену отдельно
5. **Сравните с рабочим примером** - посмотрите на `examples/sample_novel/`

### Полезные команды для отладки

```nms
scene debug {
    // Вывести значение переменной
    say "Debug: score = {score}"

    // Пауза для проверки состояния
    wait 5.0

    // Комментирование для изоляции проблемы
    // say Hero "Эта строка не выполнится"
}
```

### Чек-лист для поиска проблем

- [ ] Файл сохранён?
- [ ] Есть ли синтаксические ошибки в консоли?
- [ ] Все переменные объявлены?
- [ ] Все персонажи объявлены?
- [ ] Все сцены существуют?
- [ ] Пути к ресурсам правильные?
- [ ] JSON-файлы локализации валидные?
- [ ] Скрипт работает в `examples/sample_novel/`?

---

## Получить помощь

Если проблема не решена:

1. **Проверьте документацию**:
   - [Спецификация NM Script](../nm_script_specification.md)
   - [Быстрый старт](nm_script_quick_start.md)
   - [Поваренная книга](nm_script_cookbook.md)

2. **Изучите примеры**:
   - `examples/sample_novel/` - полноценная демо
   - `examples/tutorials/` - пошаговые примеры

3. **Поиск похожих проблем**:
   - Проверьте Issues в репозитории GitHub
   - Поищите в документации по ключевым словам

4. **Создайте минимальный воспроизводимый пример**:
   - Упростите скрипт до минимума, где проявляется проблема
   - Сохраните его отдельно для тестирования

---

**Решили проблему?** Отлично! Переходите к созданию своих сцен с помощью [Поваренной книги](nm_script_cookbook.md).
