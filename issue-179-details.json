{"author":{"id":"MDQ6VXNlcjE0MzE5MDQ=","is_bot":false,"login":"konard","name":"Konstantin Diachenko"},"body":"## Контекст\n\nАнализ тестового покрытия и выявленные пробелы, обнаруженные в ходе аудита кода (#168).\n\n## Текущее состояние\n\n- **Всего тестовых файлов**: 37\n- **Всего test cases**: ~541\n- **Покрытие исходных файлов**: 48% (37 из 77 файлов имеют тесты)\n- **Непокрытые файлы**: 40 (52%)\n\n## Непокрытые модули (критические)\n\n### 1. Scene Graph\n\n**Файлы без тестов**:\n- `engine_core/src/scene/scene_graph.cpp`\n- `engine_core/src/scene/scene_node.cpp`\n- `engine_core/src/scene/layer.cpp`\n\n**Рекомендуемые тесты**:\n- Создание и удаление узлов\n- Parent-child relationships\n- Transform propagation\n- Visibility inheritance\n- Z-order sorting\n\n---\n\n### 2. Audio Manager\n\n**Файлы без тестов**:\n- `engine_core/src/audio/audio_manager.cpp`\n- `engine_core/src/audio/audio_source.cpp`\n- `engine_core/src/audio/audio_recorder.cpp`\n\n**Рекомендуемые тесты**:\n- Инициализация и shutdown\n- Play/Pause/Stop operations\n- Volume и fade control\n- Source priority management\n- Concurrent audio playback\n\n**Примечание**: Требуется mock для miniaudio.\n\n---\n\n### 3. Virtual File System (VFS)\n\n**Файлы без тестов**:\n- `engine_core/src/vfs/pack_reader.cpp`\n- `engine_core/src/vfs/pack_writer.cpp`\n- `engine_core/src/vfs/encrypted_stream.cpp`\n\n**Рекомендуемые тесты**:\n- Pack file creation and reading\n- File encryption/decryption\n- Large file handling\n- Corrupted file detection\n- Mount point management\n\n---\n\n### 4. UI Framework (Qt)\n\n**Файлы без тестов**:\n- `editor/src/qt/nm_scene_view.cpp`\n- `editor/src/qt/storyflow_view.cpp`\n- `editor/src/qt/property_editor.cpp`\n- `editor/src/qt/timeline_widget.cpp`\n\n**Рекомендуемые тесты**:\n- Widget initialization\n- Event handling\n- Signal-slot connections\n- Drag-and-drop\n- Keyboard shortcuts\n\n**Примечание**: Использовать QtTest framework.\n\n---\n\n## Пробелы в типах тестов\n\n### 1. Error Path Testing\n\n**Проблема**: Большинство тестов проверяют только happy path.\n\n**Рекомендация**: Добавить тесты для:\n- Invalid input handling\n- Resource loading failures\n- Out of memory conditions\n- Network timeouts\n- File permission errors\n\n---\n\n### 2. Concurrency Testing\n\n**Проблема**: Нет тестов для многопоточных сценариев.\n\n**Рекомендация**: Добавить тесты для:\n- Thread safety of shared resources\n- Race condition detection\n- Deadlock prevention\n- Concurrent access patterns\n\n```cpp\nTEST_CASE(\"ResourceManager is thread-safe\", \"[threading]\")\n{\n    ResourceManager& rm = ResourceManager::instance();\n    \n    std::vector<std::thread> threads;\n    for (int i = 0; i < 10; ++i)\n    {\n        threads.emplace_back([&] {\n            for (int j = 0; j < 100; ++j)\n            {\n                auto res = rm.load(\"test_resource_\" + std::to_string(j));\n                REQUIRE(res.isOk());\n            }\n        });\n    }\n    \n    for (auto& t : threads) t.join();\n}\n```\n\n---\n\n### 3. Performance Testing\n\n**Проблема**: Нет benchmark тестов.\n\n**Рекомендация**: Добавить benchmarks для:\n- Resource loading time\n- Rendering performance\n- Script execution speed\n- Memory usage\n\n```cpp\nTEST_CASE(\"Benchmark: Scene rendering\", \"[benchmark]\")\n{\n    Scene scene;\n    // Setup scene with 1000 sprites\n    \n    BENCHMARK(\"render 1000 sprites\")\n    {\n        scene.render();\n    };\n}\n```\n\n---\n\n### 4. Integration Testing\n\n**Проблема**: Минимальное количество интеграционных тестов.\n\n**Рекомендация**: Добавить тесты для:\n- Full game loop execution\n- Save/Load cycle\n- Scene transitions\n- Script-to-engine interaction\n\n---\n\n## Структура тестовых файлов\n\nРекомендуемая структура:\n\n```\ntests/\n├── unit/\n│   ├── core/\n│   │   ├── test_result.cpp\n│   │   └── test_logger.cpp\n│   ├── audio/\n│   │   ├── test_audio_manager.cpp\n│   │   └── test_audio_source.cpp\n│   ├── vfs/\n│   │   └── test_pack_reader.cpp\n│   └── scene/\n│       └── test_scene_graph.cpp\n├── integration/\n│   ├── test_game_loop.cpp\n│   └── test_save_load.cpp\n├── benchmark/\n│   └── bench_rendering.cpp\n└── fixtures/\n    └── test_assets/\n```\n\n## Диагностика\n\n- **Инструмент**: Ручной анализ, подсчёт файлов\n- **Методология**: Сравнение src/ и tests/ directories\n\n## Критерии приёмки\n\n- [ ] Coverage ≥ 70% для engine_core\n- [ ] Coverage ≥ 60% для editor\n- [ ] Все критические модули имеют unit tests\n- [ ] Error paths покрыты тестами\n- [ ] Threading tests добавлены\n- [ ] Benchmark suite создан\n- [ ] Integration tests для основных workflow\n- [ ] CI отображает coverage metrics","comments":[],"createdAt":"2025-12-31T21:00:09Z","labels":[],"title":"[Audit] Tests & Coverage Gaps"}
